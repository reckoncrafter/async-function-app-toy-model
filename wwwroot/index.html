<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Async Function App Toy Model</title>
</head>
<style>
    body{
        max-width: 50em;
        margin: auto;
        margin-top: 2em;
    }
    #jobSelectContainer{
        display: flex;
        flex-flow: row;
        flex-wrap: wrap;
        width: 100%;
        justify-content: center;
        gap: 1em;
        margin: auto;
    }
    .jobSelect{
        flex: 1;
        border: 2px solid black;
        border-radius: 8px;
        padding: 0.5em;
    }
    .jobSelect:hover{
        background-color: #aaaaaa;
        cursor: pointer;
    }
    .jobSelect>h3{
        margin: 0;
        text-align: center;
    }

    #guidBox{
        display: flex;
        flex-direction: column;
        gap: 1em;
    }

    .activeJob{
        display: flex;
        flex-flow: row;
        justify-content: space-between;
        align-items: center;
        padding-left: 1em;
        padding-right: 1em;
        border: 2px solid black;
        border-radius: 8px;
    }
    .activeJob>div{
        display: flex;
        flex-direction: row;
        gap:1em;
        font-size:2em;
    }

    #textAreaContainer{
        margin-top:1em;
    }
</style>
<body>
    <label for="hostKey">Enter API Key</label>
    <input id="hostKey" name="hostKey" type="text">
    <br><br>
    <label for="userEmail">Destination email address for job notifications</label>
    <input id="userEmail" name="userEmail" type="email">
    <br><br>
    
    <div id="jobSelectContainer">
        <div class="jobSelect" id="shortJob">
            <h3>Short Job</h3>
            <pre id="jsonShort"></pre>
        </div>
        <div class="jobSelect" id="mediumJob">
            <h3>Medium Job</h3>
            <pre id="jsonMedium"></pre>
        </div>
        <div class="jobSelect" id="longJob">
            <h3>Long Job</h3>
            <pre id="jsonLong"></pre>
        </div>
        <div class="jobSelect" id="failJob">
            <h3>Fail Job</h3>
            <pre id="jsonFail"></pre>
        </div>
    </div>
    <div id="textAreaContainer">
        <label for="customJob">Enter custom JSON payload</label><br>
        <textarea id="customJob" name="customJob" rows="8" cols="64" style="font-family: monospace;"></textarea><br>
        <button type="submit" id="submitCustom">Submit</button>
    </div>
    <hr>
    <div id="guidBox"></div>
    
<script src="/static/jquery-4.0.0.min.js"></script>
<script>
    const entries = [
        {"div":"#shortJob","json":"/static/jobs/short.json"},
        {"div":"#mediumJob","json":"/static/jobs/medium.json"},
        {"div":"#longJob","json":"/static/jobs/long.json"},
        {"div":"#failJob","json":"/static/jobs/fail.json"}
    ]
    var jsonStrings = [];
    
    var activeJob = (guid, status) => `
    <div class="activeJob">
        <p class="jobId">${guid}</p>
        <p class="jobStatus">${status}</p>
        <div>
            <span class="trash">&#x1F5D1;</span>
        </div>
    </div>
    `

    function createActiveJob(data){
        const statusObj = JSON.parse(data["jobStatus"]);
        console.log(statusObj);

        var newActiveJob = $(activeJob(data["jobId"], statusObj.message));
        $("#guidBox").append(newActiveJob);

        var interval = setInterval(() => {
            $.ajax({
                url: `/jobStatus/${data["jobId"]}`,
                method:"GET",
                headers: {
                    "x-functions-key": $("#hostKey").val(),
                },
                success: function(res){
                    const statusObj = JSON.parse(res);
                    console.log(statusObj);
                    $(newActiveJob).children(".jobStatus").html(statusObj.message);
                    if(statusObj.running == false){
                        if(statusObj.success == false){
                            $(newActiveJob.css("background-color", "red"));
                        }
                        else{
                            $(newActiveJob).css("background-color", "#aaaaaa");
                        }
                        clearInterval(interval);
                    }
                },
                error: function(xhr, status, error){console.error("Error:", status, error);}
            });
            // $.get(`/jobStatus/${data["jobId"]}`, function(res){
            //     const statusObj = JSON.parse(res);
            //     console.log(statusObj);
            //     $(newActiveJob).children(".jobStatus").html(statusObj.message);
            //     if(statusObj.running == false){
            //         if(statusObj.success == false){
            //             $(newActiveJob.css("background-color", "red"));
            //         }
            //         else{
            //             $(newActiveJob).css("background-color", "#aaaaaa");
            //         }
            //         clearInterval(interval);
            //     }
            // }, )
        }, 1000);

        $(newActiveJob).find(".trash").click(function(){
            console.log(this);
            clearInterval(interval);
            $(newActiveJob).remove();
        })
    }

    $(function(){
        $("#submitCustom").click(function(){
            var jsonData = $("#customJob").val();
            console.log(jsonData);
            //$.post("/submitJob", jsonData, (res) => createActiveJob(res), "json");
            $.ajax({
                url: "/submitJob",
                method: "POST",
                headers: {
                    "x-functions-key": $("#hostKey").val(),
                    "x-notification-email": $("#userEmail").val()
                },
                data: jsonData,
                success: (res) => createActiveJob(res),
                error: function(xhr, status, error){console.error("Error:", status, error)},
                dataType: "json"
            });
        })

        entries.forEach(e => {
            $.get(e["json"], function(data){
                e["jsonData"] = data;
                $(`${e["div"]}>pre`).html(data);
            }, "text");

            $(e["div"]).click(function(){
                //$.post("/submitJob", e["jsonData"], (res) => createActiveJob(res), "json");
                $.ajax({
                    url: "/submitJob",
                    method: "POST",
                    headers: {
                        "x-functions-key": $("#hostKey").val(),
                        "x-notification-email": $("#userEmail").val()
                    },
                    data: e["jsonData"],
                    success: (res) => createActiveJob(res),
                    error: function(xhr, status, error){console.error("Error:", status, error)},
                    dataType: "json"
                });
            });
        });
    })


</script>
</body>
</html>